#!/bin/sh

set -e

# Start s6 supervisor in the background
s6-svscan /etc/s6 > /dev/null 2>&1 &

# Wait for services to initialize
sleep 2

# Check if Tor is working
echo -e "========================================================\n"
until curl -s --socks5 127.0.0.1:9050 'https://check.torproject.org/' | grep -q Congratulations; do
    echo "Waiting for Tor to establish..."
    sleep 2
done
echo "Tor connection established!"
echo -e "========================================================\n"

# Check external IP via Tor
curl -s --socks5 127.0.0.1:9050 https://check.torproject.org/api/ip
echo -e "\n"

# Run xmrig with proxychains4
echo -e "========================================================\n"
exec /usr/bin/proxychains4 /xmrig/build/xmrig "${@}"
